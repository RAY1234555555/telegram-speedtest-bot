#!/bin/bash
# IKUNæµ‹é€Ÿæœºå™¨äººç®¡ç†è„šæœ¬

# --- é¢œè‰²å®šä¹‰ ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# --- é…ç½® ---
SERVICE_NAME="telegram-speedtest-bot"
INSTALL_DIR="/opt/telegram-speedtest-bot"
LOG_LINES=50

# --- è¾…åŠ©å‡½æ•° ---
print_header() {
    clear
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘                    IKUNæµ‹é€Ÿæœºå™¨äººç®¡ç†é¢æ¿                      â•‘${NC}"
    echo -e "${CYAN}â•‘                        v1.0.0                                â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

print_status() {
    local status=$(systemctl is-active $SERVICE_NAME 2>/dev/null || echo "inactive")
    local enabled=$(systemctl is-enabled $SERVICE_NAME 2>/dev/null || echo "disabled")
    
    echo -e "${BLUE}ğŸ“Š å½“å‰çŠ¶æ€:${NC}"
    if [ "$status" = "active" ]; then
        echo -e "   æœåŠ¡çŠ¶æ€: ${GREEN}â—${NC} è¿è¡Œä¸­ (active)"
    else
        echo -e "   æœåŠ¡çŠ¶æ€: ${RED}â—${NC} å·²åœæ­¢ ($status)"
    fi
    
    if [ "$enabled" = "enabled" ]; then
        echo -e "   å¼€æœºå¯åŠ¨: ${GREEN}âœ“${NC} å·²å¯ç”¨"
    else
        echo -e "   å¼€æœºå¯åŠ¨: ${RED}âœ—${NC} å·²ç¦ç”¨"
    fi
    
    echo -e "   å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    echo ""
}

show_menu() {
    echo -e "${YELLOW}è¯·é€‰æ‹©æ“ä½œ:${NC}"
    echo ""
    echo -e "  ${GREEN}1.${NC} ğŸ”„ é‡å¯æœåŠ¡"
    echo -e "  ${GREEN}2.${NC} â¹ï¸  åœæ­¢æœåŠ¡"
    echo -e "  ${GREEN}3.${NC} ğŸ”„ æ›´æ–°é¡¹ç›®"
    echo -e "  ${GREEN}4.${NC} ğŸ“Š å½“å‰çŠ¶æ€"
    echo -e "  ${GREEN}5.${NC} ğŸ“‹ æŸ¥çœ‹æ—¥å¿—"
    echo -e "  ${GREEN}6.${NC} ğŸ—‘ï¸  å¸è½½æœåŠ¡"
    echo -e "  ${GREEN}7.${NC} âŒ é€€å‡º"
    echo ""
    echo -ne "${CYAN}è¯·è¾“å…¥é€‰é¡¹ [1-7]: ${NC}"
}

restart_service() {
    echo -e "${BLUE}ğŸ”„ æ­£åœ¨é‡å¯æœåŠ¡...${NC}"
    if sudo systemctl restart $SERVICE_NAME; then
        echo -e "${GREEN}âœ… æœåŠ¡é‡å¯æˆåŠŸï¼${NC}"
        sleep 2
        if systemctl is-active --quiet $SERVICE_NAME; then
            echo -e "${GREEN}âœ… æœåŠ¡è¿è¡Œæ­£å¸¸${NC}"
        else
            echo -e "${RED}âŒ æœåŠ¡å¯åŠ¨å¼‚å¸¸ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—${NC}"
        fi
    else
        echo -e "${RED}âŒ æœåŠ¡é‡å¯å¤±è´¥ï¼${NC}"
    fi
    echo ""
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
}

stop_service() {
    echo -e "${BLUE}â¹ï¸ æ­£åœ¨åœæ­¢æœåŠ¡...${NC}"
    if sudo systemctl stop $SERVICE_NAME; then
        echo -e "${GREEN}âœ… æœåŠ¡å·²åœæ­¢ï¼${NC}"
    else
        echo -e "${RED}âŒ æœåŠ¡åœæ­¢å¤±è´¥ï¼${NC}"
    fi
    echo ""
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
}

update_project() {
    echo -e "${BLUE}ğŸ”„ æ­£åœ¨æ›´æ–°é¡¹ç›®...${NC}"
    
    if [ ! -d "$INSTALL_DIR" ]; then
        echo -e "${RED}âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $INSTALL_DIR${NC}"
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
        return
    fi
    
    cd "$INSTALL_DIR" || {
        echo -e "${RED}âŒ æ— æ³•è¿›å…¥é¡¹ç›®ç›®å½•${NC}"
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
        return
    }
    
    # æ£€æŸ¥æ˜¯å¦æ˜¯gitä»“åº“
    if [ ! -d ".git" ]; then
        echo -e "${YELLOW}âš ï¸  ä¸æ˜¯gitä»“åº“ï¼Œè·³è¿‡ä»£ç æ›´æ–°${NC}"
    else
        echo -e "${BLUE}ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ...${NC}"
        if git pull; then
            echo -e "${GREEN}âœ… ä»£ç æ›´æ–°æˆåŠŸ${NC}"
        else
            echo -e "${YELLOW}âš ï¸  ä»£ç æ›´æ–°å¤±è´¥ï¼Œç»§ç»­é‡å¯æœåŠ¡${NC}"
        fi
    fi
    
    echo -e "${BLUE}ğŸ”„ é‡å¯æœåŠ¡...${NC}"
    if sudo systemctl restart $SERVICE_NAME; then
        echo -e "${GREEN}âœ… é¡¹ç›®æ›´æ–°å®Œæˆï¼æœåŠ¡å·²é‡å¯ã€‚${NC}"
        sleep 2
        if systemctl is-active --quiet $SERVICE_NAME; then
            echo -e "${GREEN}âœ… æœåŠ¡è¿è¡Œæ­£å¸¸${NC}"
        else
            echo -e "${RED}âŒ æœåŠ¡å¯åŠ¨å¼‚å¸¸ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—${NC}"
        fi
    else
        echo -e "${RED}âŒ æœåŠ¡é‡å¯å¤±è´¥ï¼${NC}"
    fi
    echo ""
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
}

show_status() {
    echo -e "${BLUE}ğŸ“Š è¯¦ç»†çŠ¶æ€ä¿¡æ¯:${NC}"
    echo ""
    
    # æœåŠ¡çŠ¶æ€
    echo -e "${CYAN}=== æœåŠ¡çŠ¶æ€ ===${NC}"
    sudo systemctl status $SERVICE_NAME --no-pager -l || echo -e "${RED}æœåŠ¡ä¸å­˜åœ¨${NC}"
    echo ""
    
    # ç³»ç»Ÿèµ„æº
    echo -e "${CYAN}=== ç³»ç»Ÿèµ„æº ===${NC}"
    echo -e "CPUä½¿ç”¨ç‡: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)%"
    echo -e "å†…å­˜ä½¿ç”¨: $(free -h | awk 'NR==2{printf "%.1f%%", $3*100/$2}')"
    echo -e "ç£ç›˜ä½¿ç”¨: $(df -h / | awk 'NR==2{print $5}')"
    echo ""
    
    # ç½‘ç»œè¿æ¥
    echo -e "${CYAN}=== ç½‘ç»œè¿æ¥ ===${NC}"
    if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
        echo -e "ç½‘ç»œè¿æ¥: ${GREEN}âœ… æ­£å¸¸${NC}"
    else
        echo -e "ç½‘ç»œè¿æ¥: ${RED}âŒ å¼‚å¸¸${NC}"
    fi
    echo ""
    
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
}

show_logs() {
    echo -e "${BLUE}ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿— (æœ€è¿‘${LOG_LINES}è¡Œ):${NC}"
    echo ""
    echo -e "${CYAN}=== å®æ—¶æ—¥å¿— ===${NC}"
    
    if systemctl list-units --full -all | grep -Fq "$SERVICE_NAME.service"; then
        echo -e "${YELLOW}æŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—æŸ¥çœ‹${NC}"
        echo ""
        sudo journalctl -u $SERVICE_NAME -f --no-pager -n $LOG_LINES
    else
        echo -e "${RED}âŒ æœåŠ¡ä¸å­˜åœ¨æˆ–æœªå®‰è£…${NC}"
        echo ""
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
    fi
}

uninstall_service() {
    echo -e "${RED}âš ï¸  è­¦å‘Š: è¿™å°†å®Œå…¨åˆ é™¤IKUNæµ‹é€Ÿæœºå™¨äººæœåŠ¡å’Œæ‰€æœ‰ç›¸å…³æ–‡ä»¶ï¼${NC}"
    echo ""
    echo -e "${YELLOW}æ­¤æ“ä½œåŒ…æ‹¬:${NC}"
    echo -e "  â€¢ åœæ­¢å¹¶åˆ é™¤systemdæœåŠ¡"
    echo -e "  â€¢ åˆ é™¤æ‰€æœ‰ç¨‹åºæ–‡ä»¶ ($INSTALL_DIR)"
    echo -e "  â€¢ åˆ é™¤é…ç½®å’Œæ—¥å¿—"
    echo ""
    
    read -p "ç¡®å®šè¦ç»§ç»­å—ï¼Ÿè¾“å…¥ 'YES' ç¡®è®¤å¸è½½: " confirm
    
    if [ "$confirm" = "YES" ]; then
        echo -e "${BLUE}ğŸ—‘ï¸ å¼€å§‹å¸è½½...${NC}"
        
        # åœæ­¢æœåŠ¡
        echo -e "${BLUE}â¹ï¸ åœæ­¢æœåŠ¡...${NC}"
        sudo systemctl stop $SERVICE_NAME 2>/dev/null || true
        
        # ç¦ç”¨æœåŠ¡
        echo -e "${BLUE}ğŸš« ç¦ç”¨æœåŠ¡...${NC}"
        sudo systemctl disable $SERVICE_NAME 2>/dev/null || true
        
        # åˆ é™¤æœåŠ¡æ–‡ä»¶
        echo -e "${BLUE}ğŸ—‘ï¸ åˆ é™¤æœåŠ¡æ–‡ä»¶...${NC}"
        sudo rm -f /etc/systemd/system/$SERVICE_NAME.service
        
        # é‡æ–°åŠ è½½systemd
        echo -e "${BLUE}ğŸ”„ é‡æ–°åŠ è½½systemd...${NC}"
        sudo systemctl daemon-reload
        
        # åˆ é™¤ç¨‹åºç›®å½•
        echo -e "${BLUE}ğŸ—‘ï¸ åˆ é™¤ç¨‹åºæ–‡ä»¶...${NC}"
        sudo rm -rf "$INSTALL_DIR"
        
        # åˆ é™¤å‘½ä»¤é“¾æ¥
        echo -e "${BLUE}ğŸ—‘ï¸ åˆ é™¤å‘½ä»¤é“¾æ¥...${NC}"
        sudo rm -f /usr/local/bin/ikunss
        
        echo -e "${GREEN}âœ… IKUNæµ‹é€Ÿæœºå™¨äººå·²å®Œå…¨å¸è½½ï¼${NC}"
        echo -e "${YELLOW}æ„Ÿè°¢ä½¿ç”¨ï¼${NC}"
        echo ""
        exit 0
    else
        echo -e "${YELLOW}âŒ å¸è½½å·²å–æ¶ˆ${NC}"
        echo ""
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
    fi
}

# --- ä¸»ç¨‹åº ---
main() {
    while true; do
        print_header
        print_status
        show_menu
        
        read -r choice
        echo ""
        
        case $choice in
            1)
                restart_service
                ;;
            2)
                stop_service
                ;;
            3)
                update_project
                ;;
            4)
                show_status
                ;;
            5)
                show_logs
                ;;
            6)
                uninstall_service
                ;;
            7)
                echo -e "${GREEN}ğŸ‘‹ å†è§ï¼${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}âŒ æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©${NC}"
                sleep 1
                ;;
        esac
    done
}

# æ£€æŸ¥æ˜¯å¦ä»¥rootæƒé™è¿è¡ŒæŸäº›æ“ä½œ
check_permissions() {
    if ! sudo -n true 2>/dev/null; then
        echo -e "${YELLOW}âš ï¸  æŸäº›æ“ä½œéœ€è¦sudoæƒé™${NC}"
        echo ""
    fi
}

# å¯åŠ¨ä¸»ç¨‹åº
check_permissions
main
